# Multi-stage Dockerfile for Full-Stack Biskaken Auto Deployment
FROM node:20-alpine AS base

# Install system dependencies
RUN apk add --no-cache bash curl postgresql-client

#################################################################
# Stage 1: Build Frontend
#################################################################
FROM base AS frontend-builder
WORKDIR /app/frontend

# Copy frontend package files
COPY package*.json ./
COPY vite.config.ts ./
COPY tsconfig.json ./

# Install frontend dependencies
RUN npm install

# Copy frontend source code
COPY src ./src
COPY public ./public
COPY index.html ./
COPY components ./components
COPY pages ./pages
COPY services ./services
COPY store ./store
COPY types.ts ./
COPY constants.tsx ./
COPY App.tsx ./

# Build frontend for production
ENV VITE_API_URL=https://biskakenauto.rpnmore.com
RUN npm run build

#################################################################
# Stage 2: Build Backend
#################################################################
FROM base AS backend-builder
WORKDIR /app/backend

# Copy backend package files
COPY biskaken-auto-api/package*.json ./
COPY biskaken-auto-api/tsconfig.json ./

# Install backend dependencies
RUN npm install

# Copy backend source code and database schema
COPY biskaken-auto-api/src ./src
COPY biskaken-auto-api/prisma ./prisma

# Generate Prisma client
RUN npx prisma generate

# Build backend
RUN npm run build

#################################################################
# Stage 3: Production Runtime
#################################################################
FROM base AS production
WORKDIR /app

# Copy built backend
COPY --from=backend-builder /app/backend/dist ./dist
COPY --from=backend-builder /app/backend/node_modules ./node_modules
COPY --from=backend-builder /app/backend/package.json ./
COPY --from=backend-builder /app/backend/prisma ./prisma

# Ensure Prisma client is available in production
RUN npx prisma generate

# Copy built frontend to be served by backend
COPY --from=frontend-builder /app/frontend/dist ./public

# Create startup script for database initialization and server start
RUN cat > start.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ Starting Biskaken Auto Production Server..."

# Wait for database to be ready
echo "â³ Waiting for database connection..."
until pg_isready -h ${DB_HOST:-localhost} -p ${DB_PORT:-5432} -U ${DB_USER:-postgres}; do
  echo "Database not ready, waiting..."
  sleep 2
done

echo "âœ… Database connection established"

# Generate Prisma client (ensure it's available)
echo "ğŸ”§ Generating Prisma client..."
npx prisma generate

# Run database migrations
echo "ğŸ”„ Running database migrations..."
npx prisma migrate deploy

# Seed database with initial data if needed
echo "ğŸŒ± Seeding database..."
npx prisma db seed || echo "Seed completed or already exists"

# Start the server
echo "ğŸŒŸ Starting application server..."
exec node dist/server.js
EOF

RUN chmod +x start.sh

# Environment variables
ENV NODE_ENV=production
ENV PORT=5000
ENV APP_URL=https://biskakenauto.rpnmore.com

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:5000/health || exit 1

EXPOSE 5000

# Start application
CMD ["./start.sh"]