# Biskaken Auto Shop Management - Production Nixpacks Configuration
# Unified full-stack deployment for Dokploy

[variables]
NODE_ENV = "production"
PORT = "3000"
NODE_VERSION = "20"

[phases.setup]
nixPkgs = ["nodejs_20", "postgresql", "curl", "bash", "coreutils"]

[phases.install]
cmds = [
    "echo 'ğŸ“¦ Installing dependencies...'",
    "npm ci --include=dev",
    "echo 'ğŸ“¦ Installing backend dependencies...'",
    "cd biskaken-auto-api && npm ci --include=dev"
]
cacheDirectories = ["node_modules", "biskaken-auto-api/node_modules"]

[phases.build]
cmds = [
    "echo 'ğŸ—ï¸  Building frontend...'",
    "npm run build:frontend",
    "echo 'ğŸ—ï¸  Building backend...'", 
    "cd biskaken-auto-api",
    "npx prisma generate",
    "npx tsc",
    "echo 'ğŸ“ Copying frontend to backend...'",
    "mkdir -p public",
    "cp -r ../dist/* ./public/",
    "echo 'âœ… Build completed successfully!'"
]
cacheDirectories = ["dist", "biskaken-auto-api/dist", "biskaken-auto-api/public"]

[start]
cmd = """
echo 'ğŸš€ Starting Biskaken Auto Production...'
cd biskaken-auto-api

echo 'â³ Waiting for database connection...'
MAX_RETRIES=30
RETRY_COUNT=0

while ! pg_isready -h ${DATABASE_HOST:-localhost} -p ${DATABASE_PORT:-5432} -U ${DATABASE_USER:-postgres} -q 2>/dev/null; do
    RETRY_COUNT=$((RETRY_COUNT+1))
    if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
        echo 'âŒ Database connection failed after 30 attempts'
        exit 1
    fi
    echo "Database not ready (attempt $RETRY_COUNT/30), waiting..."
    sleep 2
done

echo 'âœ… Database connected successfully'

echo 'ğŸ”§ Generating Prisma client...'
npx prisma generate

echo 'ğŸ”„ Running database migrations...'
npx prisma migrate deploy

echo 'ğŸŒ± Seeding database with initial data...'
npx prisma db seed || echo 'Database seeding completed'

echo 'ğŸŒŸ Starting application server on port 3000...'
echo 'ğŸŒ Application URL: https://biskakenauto.rpnmore.com'
echo 'ğŸ” Default admin credentials: admin@biskaken.com / admin123'
echo 'â° Started at: '$(date)

exec node dist/server.js
"""