# Biskaken Auto Shop Management - Production Nixpacks Configuration
# Unified full-stack deployment for Dokploy

[variables]
NODE_ENV = "production"
PORT = "3000"
NODE_VERSION = "20"

[phases.setup]
nixPkgs = ["nodejs_20", "postgresql", "curl", "bash", "coreutils"]

[phases.install]
cmds = [
    "echo 'ğŸ“¦ Installing dependencies...'",
    "npm ci --include=dev",
    "echo 'ğŸ“¦ Installing backend dependencies...'",
    "cd biskaken-auto-api && npm ci --include=dev"
]
cacheDirectories = ["node_modules", "biskaken-auto-api/node_modules"]

[phases.build]
cmds = [
    "echo 'ğŸ—ï¸  Building frontend...'",
    "npm run build:frontend",
    "echo 'ğŸ—ï¸  Building backend...'", 
    "cd biskaken-auto-api",
    "npx prisma generate",
    "npx tsc",
    "echo 'ğŸ“ Copying frontend to backend...'",
    "mkdir -p public",
    "cp -r ../dist/* ./public/",
    "echo 'âœ… Build completed successfully!'"
]
cacheDirectories = ["dist", "biskaken-auto-api/dist", "biskaken-auto-api/public"]

[start]
cmd = "cd biskaken-auto-api && echo 'ğŸš€ Starting Biskaken Auto Production...' && echo 'â³ Waiting for database...' && until pg_isready -h ${DATABASE_HOST:-localhost} -p ${DATABASE_PORT:-5432} -U ${DATABASE_USER:-postgres} -q 2>/dev/null; do echo 'Database not ready, waiting...'; sleep 3; done && echo 'âœ… Database connected' && npx prisma generate && npx prisma migrate deploy && (npx prisma db seed || echo 'Seed completed') && echo 'ğŸŒŸ Starting server...' && echo 'ğŸ” Admin: admin@biskaken.com / admin123' && node dist/server.js"