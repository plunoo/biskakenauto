# Biskaken Auto Shop Management - Unified Production Build
# Single application with frontend + backend + database in one deployment

[variables]
NODE_ENV = "production"
PORT = "5000"
NODE_VERSION = "20"
NPM_CONFIG_CACHE = "/tmp/.npm"

# Install system packages including PostgreSQL client
[phases.setup]
nixPkgs = ["nodejs_20", "postgresql", "curl", "bash", "coreutils"]

# Single install phase for all dependencies
[phases.install]
cmds = [
    "echo 'ğŸ“¦ Installing unified application dependencies...'",
    "npm install --prefer-offline --no-audit --include=dev",
    "echo 'ğŸ”§ Fixing Rollup native dependencies issue...'",
    "npm install @rollup/rollup-linux-x64-gnu --save-optional",
    "npm rebuild"
]
cacheDirectories = ["node_modules"]

# Unified build phase - Everything in one go
[phases.build]
cmds = [
    "echo 'ğŸ”§ Generating Prisma client...'",
    "npx prisma generate",
    "echo 'ğŸ—ï¸  Building complete application (frontend + backend)...'",
    "npm run build",
    "echo 'âœ… Unified build completed successfully!'"
]
cacheDirectories = ["dist", "public", "node_modules/.prisma"]

# Single start command for unified application
[start]
cmd = "echo 'ğŸš€ Starting Biskaken Auto Unified Application...' && echo 'â³ Waiting for database connection...' && until pg_isready -h ${DATABASE_HOST:-localhost} -p ${DATABASE_PORT:-5432} -U ${DATABASE_USER:-postgres} -q 2>/dev/null; do echo 'Database not ready, retrying in 3s...'; sleep 3; done && echo 'âœ… Database connected successfully' && echo 'ğŸ”„ Running database migrations...' && npx prisma migrate deploy && echo 'ğŸŒ± Seeding database...' && (npm run db:seed 2>/dev/null || echo 'Seeding completed or skipped') && echo 'ğŸŒŸ Starting unified server...' && echo 'ğŸ” Admin: admin@biskaken.com / admin123' && npm start"