# Biskaken Auto Shop Management - Unified Production Build
# Single application with frontend + backend + database in one deployment

[variables]
NODE_ENV = "production"
PORT = "5000"
NODE_VERSION = "20"
NPM_CONFIG_CACHE = "/tmp/.npm"

# Install system packages 
[phases.setup]
nixPkgs = ["nodejs_20", "curl", "bash", "coreutils"]

# Single install phase for all dependencies
[phases.install]
cmds = [
    "echo 'ğŸ“¦ Installing unified application dependencies...'",
    "npm ci --include=dev",
    "echo 'ğŸ”§ Fixing Rollup native dependencies issue...'",
    "npm install @rollup/rollup-linux-x64-gnu --save-optional",
    "npm rebuild"
]

# Unified build phase - Everything in one go
[phases.build]
cmds = [
    "echo 'ğŸ”§ Ensuring Rollup dependencies are available...'",
    "npm install @rollup/rollup-linux-x64-gnu --save-optional",
    "echo 'ğŸ”§ Generating Prisma client...'",
    "npx prisma generate",
    "echo 'ğŸ—ï¸  Building complete application (frontend + backend)...'",
    "npm run build",
    "echo 'âœ… Unified build completed successfully!'"
]

# Single start command for unified application with embedded SQLite
[start]
cmd = "echo 'ğŸš€ Starting Biskaken Auto Unified Application...' && echo 'ğŸ”„ Running database migrations...' && npx prisma migrate deploy && echo 'ğŸŒ± Seeding database...' && (npm run db:seed 2>/dev/null || echo 'Seeding completed or skipped') && echo 'ğŸŒŸ Starting unified server...' && echo 'ğŸ” Admin: admin@biskaken.com / admin123' && npm start"